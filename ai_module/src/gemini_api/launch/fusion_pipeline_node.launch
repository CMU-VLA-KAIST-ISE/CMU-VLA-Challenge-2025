<launch>
  <!-- ====== ARGS ====== -->
  <arg name="node_name"            default="fusion_pipeline_node"/>
  <arg name="camera_image_topic"   default="/camera/image"/>
  <arg name="cloud_topic"          default="/color_scan_relative"/>
  <arg name="prompt_topic"         default="/instruction"/>

  <arg name="dump_dir"             default="/tmp/fusion_faas"/>
  <arg name="min_points"           default="30"/>
  <arg name="gemini_model"         default="gemini-2.5-flash"/>
  <arg name="map_frame"            default="odom"/>
  <arg name="seg_prompt"           default=""/>
  <arg name="cooldown_sec"         default="10.0"/>

  <!-- move_base(goal) 옵션 -->
  <arg name="publish_goal_on_single" default="false"/>
  <arg name="goal_topic"             default="/move_base_simple/goal"/>

  <!-- dummyVLM waypoint 인터페이스 -->
  <arg name="use_waypoint_interface"    default="true"/>
  <arg name="waypoint_frame"            default="odom"/>
  <arg name="waypoint_publish_rate"     default="10.0"/>
  <arg name="waypoint_publish_duration" default="6.0"/>

  <!-- Camera (panorama) -->
  <arg name="cam_width"            default="1920"/>
  <arg name="cam_height"           default="640"/>
  <arg name="cam_hfov_deg"         default="360.0"/>
  <arg name="cam_vfov_deg"         default="120.0"/>

  <!-- Lidar -> Camera extrinsic (meters/radians) -->
  <arg name="l2c_x"                default="-0.12"/>
  <arg name="l2c_y"                default="-0.075"/>
  <arg name="l2c_z"                default="0.265"/>
  <arg name="l2c_roll"             default="-1.5707963"/>
  <arg name="l2c_pitch"            default="0.0"/>
  <arg name="l2c_yaw"              default="-1.5707963"/>

  <!-- python 인터프리터(3.10) 강제 -->
  <arg name="python"               default="/opt/conda/envs/python310/bin/python3"/>

  <!-- ====== NODE ====== -->
  <node pkg="gemini_api"
        type="fusion_pipeline_node.py"
        name="$(arg node_name)"
        output="screen"
        respawn="false"
        launch-prefix="$(arg python)">

    <!-- API 키 패스스루 -->
    <env name="GOOGLE_API_KEY" value="$(env GEMINI_API_KEY)"/>

    <!-- core params -->
    <param name="dump_dir"         value="$(arg dump_dir)"/>
    <param name="min_points"       value="$(arg min_points)"/>
    <param name="gemini_model"     value="$(arg gemini_model)"/>
    <param name="map_frame"        value="$(arg map_frame)"/>
    <param name="prompt_topic"     value="$(arg prompt_topic)"/>
    <param name="seg_prompt"       value="$(arg seg_prompt)"/>
    <param name="cooldown_sec"     value="$(arg cooldown_sec)"/>

    <!-- move_base(goal) 옵션 -->
    <param name="publish_goal_on_single" value="$(arg publish_goal_on_single)"/>
    <param name="goal_topic"             value="$(arg goal_topic)"/>

    <!-- waypoint(dummVLM) 인터페이스 -->
    <param name="use_waypoint_interface"    value="$(arg use_waypoint_interface)"/>
    <param name="waypoint_frame"            value="$(arg waypoint_frame)"/>
    <param name="waypoint_publish_rate"     value="$(arg waypoint_publish_rate)"/>
    <param name="waypoint_publish_duration" value="$(arg waypoint_publish_duration)"/>

    <!-- camera -->
    <param name="camera/width"     value="$(arg cam_width)"/>
    <param name="camera/height"    value="$(arg cam_height)"/>
    <param name="camera/hfov_deg"  value="$(arg cam_hfov_deg)"/>
    <param name="camera/vfov_deg"  value="$(arg cam_vfov_deg)"/>

    <!-- L2C extrinsic -->
    <param name="l2c/x"            value="$(arg l2c_x)"/>
    <param name="l2c/y"            value="$(arg l2c_y)"/>
    <param name="l2c/z"            value="$(arg l2c_z)"/>
    <param name="l2c/roll"         value="$(arg l2c_roll)"/>
    <param name="l2c/pitch"        value="$(arg l2c_pitch)"/>
    <param name="l2c/yaw"          value="$(arg l2c_yaw)"/>

    <!-- topic remaps -->
    <remap from="/camera/image"        to="$(arg camera_image_topic)"/>
    <remap from="/color_scan_relative" to="$(arg cloud_topic)"/>
    <remap from="/color_scan_rel"      to="$(arg cloud_topic)"/>
  </node>
</launch>
